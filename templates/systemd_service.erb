# Control of all workers jointly is done through the <%= @service_name %>.target.
#
# To restart all workers:
#   systemctl restart <%= @service_name %>.target
# To restart one particular worker:
#   systemctl restart <%= @unit_name %>.service
#

[Unit]
Description=<%= @unit_name %>
PartOf=<%= @service_name %>.target
After=<%= @service_name %>-flush.service<% if @prev_unit_name %> <%= @prev_unit_name %>.service<% end %>

[Service]
Type=simple
ExecStart=/usr/bin/php <%= @site_root %>/framework/cli-script.php dev/resque/run queue=* count=1
User=www-data
Restart=on-failure
SyslogIdentifier=<%= @unit_name %>

# Sending SIGQUIT ensures the worker exits gracefully: it signals <%= @unit_name %> to terminate after
# the current job has finished. To have this work properly, we must use KillMode=process, otherwise
# subshells will be terminated (and the job will die).
KillMode=process
KillSignal=SIGQUIT

# After this time SIGKILL will be sent, guaranteeing worker restart, at a cost of user jobs being terminated.
TimeoutStopSec=24hours

[Install]
WantedBy=<%= @service_name %>.target
